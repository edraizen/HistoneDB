{% load browse_filters %}

<div id="sequence_toolbar_{{ page_name }}">
    <div class="btn-group" role="group" aria-label="...">
        <div class="btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-default" id="msa_modal_button_{{ page_name }}"><span class="glyphicon glyphicon-align-right" aria-hidden="true"></span> View{% if "curated" in page_name %} Full{% endif %} MSA</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expander="false"><span class="glyphicon glyphicon-export" aria-hidden="true"></span> Export <span class="caret"></span></button>
            <ul class="dropdown-menu" role="menu">
                <li><a href="#" id="download_fasta_{{ page_name }}">Download FASTA</a></li>
                <li><a href="#" id="entrez_{{ page_name }}">View in Entrez</a></li>
            </ul>
        </div>
        <div class="btn-group" role="group" aria-label="...">
            {% if page_name == "basket" %}
            <button type="button" class="btn btn-default" id="remove_from_basket_{{ page_name }}"><span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span> Remove from Basket <span class="badge badge-basket"></span></button>
            {% else %}
            <button type="button" class="btn btn-default" id="add_to_basket_{{ page_name }}"><span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span> Add to Basket <span class="badge badge-basket"></span></button>
            {% endif %}
        </div>
        <div class="btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-default" id="show_advanced_filter_{{ page_name }}" {% if blast_results %}disabled="disabled"{% endif %}>
              <span class="glyphicon glyphicon-search" aria-hidden="true"></span> Filter
            </button>
        </div>
        <div class="btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-default" id="reset_filter_{{ page_name }}"  {% if blast_results %}disabled="disabled"{% endif %}><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Reset</button>
        </div>
        {% if "curated" not in page_name %}
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expander="false"><span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Expert <span class="caret"></span></button>
            <ul class="dropdown-menu" role="menu">
                <li><a href="#" id="scores_modal_button_{{ page_name }}">View against all profiles</a></li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<div class="container" style="margin-top:5px;">
  {% if "curated" in page_name %}
  <h4 class="page-header">Quick MSA - Align a single sequence to canonical <small>Select row to display here, else select multiple and click "View Full MSA"</small></h4>
  <div id="quick_msa-{{page_name}}"></div>
  {% endif %}
  <table id="sequence_table_{{ page_name }}"></table>
</div>

<div class="modal fade" id="msa_modal_{{ page_name }}" tabindex="-1" role="dialog" aria-labelledby="seqs" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="seqs_{{ page_name }}">Sequence(s)</h4>
      </div>
      {% include "seed.html" with msa_id="modal_"|add:page_name %}
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% if "curated" not in page_name %}
<div class="modal fade" id="scores_modal_{{ page_name }}" tabindex="-1" role="dialog" aria-labelledby="all_profiles" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="all_profiles_{{ page_name }}">All Profile Scores</h4>
      </div>
      {% include "scores.html" with modal=True%}
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
<script>
var $table_{{ page_name }} = $('#sequence_table_{{ page_name }}'),
    $msa_modal_button_{{ page_name }} = $('#msa_modal_button_{{ page_name }}'),
    $scores_modal_button_{{ page_name }} = $('#scores_modal_button_{{ page_name }}'),
    $download_fasta_{{ page_name }} = $('#download_fasta_{{ page_name }}'),
    $entrez_{{ page_name }} = $('#entrez_{{ page_name }}'),
    $reset_{{ page_name }} = $('#reset_filter_{{ page_name }}');



    $reset_{{ page_name }}.click(function(){
      {% if original_query|length == 0 %}
      if(!confirm("No original query. Do you want to view all sequences? If not, use the Advanced Filter option.")) return;
      {% else %}
      if(!confirm("Do you want to clear all filters and return to original query?")) return;
      {% endif %}

      document.location.href = "{{ request.path }}";
    });


    function getSelectedIDs{{ page_name }}(){
      selections = $('#sequence_table_{{ page_name }}').bootstrapTable('getSelections');
      console.log(selections);
      var ids = [];
      for (var i = 0; i < selections.length; i++) {
        ids.push(selections[i].id);
      }
      console.log(ids);
      if(ids.length==0){
        alert("You must select one ore more sequences.");
        return;
      }
      return ids;
    };
    
    {% if "curated" not in page_name %}
    $scores_modal_button_{{ page_name }}.click(function() {
      ids = getSelectedIDs{{ page_name }}();
      make_scores_table($('#scores_table_div'), ids, "418px");
      $('#scores_modal_{{ page_name }}').modal('show');
    });
    {% endif %}
    {% if page_name != "basket" %}
    $("#add_to_basket_{{ page_name }}").click(function (){
      var basket = JSON.parse(localStorage.getItem('basket')) || [];
      var ids = getSelectedIDs{{ page_name }}();
      console.log("basket: "+basket);
      console.log("ids: "+ids);
      var new_basket = $.extend(true, basket, ids);
      console.log("new basket: "+new_basket);
      console.log(ids);
      localStorage.setItem('basket', JSON.stringify(basket));
      $(".badge-basket").html(basket.length);
    });
    {% else %}
    $("#remove_from_basket_{{ page_name }}").click(function (){
      var basket = JSON.parse(localStorage.getItem('basket')) || [];
      var ids = getSelectedIDs{{ page_name }}();
      console.log("TO EMPTY: ");
      console.log(ids);
      console.log(basket);
      for(var i=basket.length-1; i>=0; i--){
        for (var j = 0; j < ids.length; j++) {
          if(ids[j] == basket[i]){
            console.log
            basket.splice(i, 1);
          }
        }
      }
      console.log(basket);
      localStorage.setItem('basket', JSON.stringify(basket));
      $(".badge-basket").html(basket.length);
      reloadBasket();
      $('#sequence_table_{{ page_name }}').bootstrapTable('refresh');
    });
    {% endif %}
    $(function () {
        function variantFormatter(value, row, index) {
          return [
            value,
            '<div class="button-group dropdown pull-right">',
            '<a href="#" class="dropdown-toggle rowlink" data-toggle="dropdown" aria-haspopup="true">',
            '<span class="caret"></span>',
            '<ul class="dropdown-menu" role="menu">',
            '<li><a href="#" id="variant_actions_browse_core">Browse core histone</a></li>',
            '<li><a href="#" id="variant_actions_browse_variant">Browse variant</a></li>',
            '</ul>',
            '</a>',
            '</div'
          ].join('');
        }

        function taxonomyFormatter(value, row, index) {
          return [
            value,
            '<div class="button-group dropdown pull-right">',
            '<a href="#" class="dropdown-toggle rowlink" data-toggle="dropdown" aria-haspopup="true">',
            '<span class="caret"></span>',
            '<ul class="dropdown-menu" role="menu">',
            '<li><a href="#" id="taxonomy_actions_browse_variant">Browse variant within taxonomy</a></li>',
            '<li><a href="#" id="taxonomy_actions_browse_all">Browse all taxonomy</a></li>',
            '<li><a href="#" id="taxonomy_actions_browse_ncbi">View NCBI Taxonomy record</a></li>',
            '</ul>',
            '</a>',
            '</div'
          ].join('');
        }

        window.variantEvents = {
          'click #variant_actions_browse_core': function (e, value, row, index) {
              document.location.href = "{% url 'browse.views.search' %}?search="+row.core;
          },
          'click #variant_actions_browse_variant': function (e, value, row, index) {
              document.location.href = "{% url 'browse.views.search' %}?search="+row.variant;
          }
        }

        window.taxonomyEvents = {
          'click #taxonomy_actions_browse_variant': function (e, value, row, index) {
              document.location.href = "{% url 'browse.views.search' %}?id_variant="+row.variant+"&id_taxonomy="+row.taxid;
          },
          'click #taxonomy_actions_browse_all': function (e, value, row, index) {
              document.location.href = "{% url 'browse.views.search' %}?id_taxonomy="+row.taxid;
          },
          'click #taxonomy_actions_browse_ncbi': function (e, value, row, index) {
              document.location.href = "http://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Info&id="+row.taxid+"&lvl=3&lin=f&keep=1&srchmode=5&unlock";
          }
        }

        $('#sequence_table_{{ page_name }}').bootstrapTable({
          pagination:true,
          pageList:[5, 10, 20, 50, 100, 200, 500],
          cookie:true,
          cookieIdTable:"table-{{ page_name }}",
          
          height:{% if not curated %}750{% else %}450{% endif %},
          {% if blast_results %}
          data: {% autoescape off %}{{ blast_results|jsonify }}{% endautoescape %},
          sidePagination:"client",
          {% else %}
          url: "{% url 'browse.views.get_sequence_table_data' %}",
          sidePagination:"server",
          queryParams: function(params){
            var current_query = {% autoescape off %}{{ current_query|jsonify }}{% endautoescape %};
            {% if curated %}
            current_query["id_reviewed"] = true;
            {% endif %}
            if (typeof extra_seq_params_{{ page_name }} == "undefined") {
              var extra_params = {};
            }
            else{
              var extra_params = extra_seq_params_{{ page_name }};
            }
            console.log($.extend(params, current_query, extra_params));
            return $.extend(params, current_query, extra_params);
          },
          {% endif %}
          columns: [
            {field:"state", checkbox:true},
            {field:"id", sortable:true, title:"GI", clickToSelect:false},
            {field:"variant", sortable:true, title:"Variant", clickToSelect:false, events:variantEvents, formatter:variantFormatter},
            {field:"gene", sortable:true, title:"Gene", clickToSelect:false},
            {field:"splice", sortable:true, title:"Splice", clickToSelect:false},
            {field:"taxonomy", sortable:true, title:"Taxonomy", clickToSelect:false, events:taxonomyEvents, formatter:taxonomyFormatter},
            {% if not curated %}
            {field:"header", sortable:true, width:50, title:"Current GenBank Description", rowspan:1, clickToSelect:false},
            {field:"score", sortable:true, title:"Score", clickToSelect:false},
            {field:"evalue", sortable:true, title:"E-value", clickToSelect:false},
            {% endif %}
            {% if blast_results %}
            {field:"search_e", sortable:true, , clickToSelect:false, title:"BLAST E-value", cellStyle: function(value, row, index) { return {classes:"danger"};}},
            {% endif %}
          ],
          showColumns:true,
          search:true,
          showToggle:true,
          clickToSelect:true,
          showRefresh:true,
          toolbar:"#sequence_toolbar_{{ page_name }}",
          {% if formatNoMatches %}
          formatNoMatches: function(){ return "{{ formatNoMatches }}"; },
          {% endif %}
          {% if "curated" in page_name %}
          onLoadSuccess: function(data){
            createMSA("quick_msa-{{page_name}}", "{% url 'browse.views.get_aln_and_features' %}?id="+data.rows[0].id, "", 975, 75, false);
          },
          onCheck:function(row){
            createMSA("quick_msa-{{page_name}}", "{% url 'browse.views.get_aln_and_features' %}?id="+row.id, "", 975, 75, false);
          }
          {% endif %}
        });
        
        $("#show_advanced_filter_{{ page_name }}").click( function (){
          open_advanced_filter("filter", $table_{{ page_name }});
        });

        $msa_modal_button_{{ page_name }}.click(function() {
          ids = getSelectedIDs{{ page_name }}();
          params = "?";
          for (var i = 0; i < ids.length; i++) {
            params += "id="+ids[i]+"&"
          }
          createMSA("msa_div_modal_{{ page_name }}", "{% url 'browse.views.get_aln_and_features' %}"+params.substring(0, params.length-1), "{% url 'browse.views.get_aln_and_features' %}?download=true", 400, true);
          $('#msa_modal_{{ page_name }}').modal('show');
        });

        $download_fasta_{{ page_name }}.click(function() {
          ids = getSelectedIDs{{ page_name }}();
          params = "?";
          for (var i = 0; i < ids.length; i++) {
            params += "id="+ids[i]+"&"
          }
          params += "format=fasta&download=true";
          document.location.href = "{% url 'browse.views.get_all_sequences' %}"+params;
        });

        $entrez_{{ page_name }}.click(function () {
            ids = getSelectedIDs{{ page_name }}();
            url = "http://www.ncbi.nlm.nih.gov/protein/?term=";
            for (var i = 0; i < ids.length; i++) {
              url += ids[i]+"[uid]+OR+"
            }
            document.location.href = url.substring(0, url.length-4);
        });

        {% if filter_errors %}
        open_advanced_filter("filter", $table_{{ page_name }});
        {% endif %}
      });
</script>
